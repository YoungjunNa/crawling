#한우API가져오기

library("XML")
library("dplyr")
hanwoo<-read.csv("cattle.txt",colClasses=c("character"),col.names="Cattle_No")

results<-data.frame(farmerNm=NA,farmAddr=NA,SexNm=NA,birthYMD=NA,abattDate=NA,animalNo=NA,gradeNm=NA,qgrade=NA,wgrade=NA,weight=NA,windex=NA)

for(i in 0:1807){
  nb=i+1
  
  #API
  API_key<-"please get your API key"
  Cattle_No<-hanwoo[nb,]

  #basic information
  url1<-paste("http://data.ekape.or.kr/openapi-data/service/user/mtrace/breeding/cattle?cattleNo=",Cattle_No,"&ServiceKey=",API_key,sep="")
  xmlfile1<-xmlParse(url1)
  xmltop1<-xmlRoot(xmlfile1)
  get_inform<-xmlToDataFrame(getNodeSet(xmlfile1,"//item"),stringsAsFactors=FALSE)
  
  #issueNo 가져오기
  url2<-paste("http://data.ekape.or.kr/openapi-data/service/user/grade/confirm/issueNo?animalNo=",Cattle_No,"&ServiceKey=",API_key,sep="")
  xmlfile2<-xmlParse(url2)
  xmltop2<-xmlRoot(xmlfile2)
  get_issueNo<-xmlToDataFrame(getNodeSet(xmlfile2,"//item"),stringsAsFactors=FALSE)

  Issue_No<-gsub(" ","",as.character(get_issueNo$issueNo)) #OR Issue_No<-stringr::str_trim(as.character(get_issueNo$issueNo))

  #도체정보 가져오기
  url3<-paste("http://data.ekape.or.kr/openapi-data/service/user/grade/confirm/cattle?issueNo=",Issue_No,"&ServiceKey=",API_key,sep="")
  xmlfile3<-xmlParse(url3)
  xmltop3<-xmlRoot(xmlfile3)
  get_hanwoo<-xmlToDataFrame(getNodeSet(xmlfile3,"//item"),stringsAsFactors=FALSE) %>% try(silent=T)

  results[nb,1]<-get_inform$farmNm 
  results[nb,2]<-get_inform$farmAddr
  results[nb,3]<-get_inform$sexNm 
  results[nb,4]<-get_inform$birthYmd
  
  results[nb,6]<-get_issueNo$animalNo 
  
  results[nb,5]<-get_hanwoo$abattDate %>% try(silent=T)
  results[nb,7]<-get_hanwoo$gradeNm %>% try(silent=T)
  results[nb,8]<-get_hanwoo$qgrade %>% try(silent=T)
  results[nb,9]<-get_hanwoo$wgrade %>% try(silent=TRUE)
  results[nb,10]<-get_hanwoo$weight %>% try(silent=TRUE)
  results[nb,11]<-get_hanwoo$windex %>% try(silent=TRUE)
}

#%>% try(silent=TRUE)
#write.csv(results, "results.txt", row.names=FALSE)


